<?php   $profileShown = false; if (($user = $visitor->operator_user) !== false) : ?><?php  $profileShown = true; $hideThumbs = true;$extraMessage = $user->job_title != '' ? htmlspecialchars($user->job_title) : 'Asistente personal';?><div class="operator-info float-break"><div class="pull-left pr5"><?php  if ($user->has_photo) : ?><img src="<?php  echo $user->photo_path?>" alt="<?php  echo htmlspecialchars($user->name_support)?>" /><?php  else : ?><i class="icon-assistant material-icons">account_box</i><?php  endif;?></div><div class="pl10"><div><strong><?php  echo htmlspecialchars($user->name_support)?></strong></div><?php  if (isset($extraMessage)) : ?><i><?php  echo $extraMessage;?></i><?php  endif;?><?php   ?><?php  if (!isset($hideThumbs) || $hideThumbs == false) : ?><?php  if (!isset($theme) || $theme === false || $theme->show_voting == 1) : ?><i class="material-icons<?php  if ($chat->fbst == 1) : ?> up-voted<?php  endif;?> up-vote-action" role="button" data-id="1" onclick="lhinst.voteAction($(this))" >thumb_up</i><i class="material-icons<?php  if ($chat->fbst == 2) : ?> down-voted<?php  endif;?> down-vote-action" role="button" data-id="2" onclick="lhinst.voteAction($(this))">thumb_down</i><?php  endif;?><?php  if ($user->skype != '') : ?><a href="skype:<?php  echo htmlspecialchars($user->skype)?>?call" class="material-icons" title="Llamada Skype">phone_in_talk</a><?php  endif;?><?php  endif;?><?php   ?></div></div><?php  endif;?><form action="" id="ReadOperatorMessage" method="post" onsubmit="return <?php  if (isset($start_data_fields['message_auto_start']) && $start_data_fields['message_auto_start'] == true) : ?>lhinst.prestartChat('<?php  echo time()?>',$(this))<?php  else : ?>lhinst.addCaptcha('<?php  echo time()?>',$(this))<?php  endif?>"><div id="messages" class="read-operator-message"><div class="msgBlock" id="messagesBlock"><div class="message-row message-admin<?php  if ($profileShown == true) : ?> message-row-profile-shown<?php  endif?>"><div class="msg-date"><?php  echo date(erLhcoreClassModule::$dateHourFormat,time()-5); ?></div><?php  if ($profileShown == false) : ?><span class="usr-tit op-tit"><?php  echo $visitor->operator_user !== false ? htmlspecialchars($visitor->operator_user->name_support) : (!empty($visitor->operator_user_proactive) ? htmlspecialchars($visitor->operator_user_proactive) : 'Soporte en Línea') ?></span><?php  endif;?><?php  echo erLhcoreClassBBCode::make_clickable(htmlspecialchars($visitor->operator_message)); ?></div><?php  if (isset($start_data_fields['show_messages_box']) && $start_data_fields['show_messages_box'] == true) : ?><?php  $formIdentifier = '#ReadOperatorMessage';?><script>var visitorTitle =  <?php  echo json_encode(htmlspecialchars_decode('Yo',ENT_QUOTES))?>;$( "<?php  echo $formIdentifier?>" ).submit(function() {if ($('#messagesBlock > .message-row.response').size() == 0 && $(this).attr('key-up-started') != 1) {jQuery('<div/>', {'class': 'message-row response',text: $('#id_Question').val()}).appendTo('#messagesBlock').prepend('<span class="usr-tit vis-tit">'+<?php  echo json_encode(htmlspecialchars_decode('Yo',ENT_QUOTES))?>+'</span>');$('#messagesBlock').animate({ scrollTop: $('#messagesBlock').prop('scrollHeight') }, 1000);}});</script><?php  endif;?></div></div><?php  if (isset($errors)) : ?><div class="pt10"><?php  if (isset($errors)) : ?><div data-alert class="alert alert-danger alert-dismissible fade in"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><ul class="validation-ul"><?php  foreach ($errors as $err) : ?><li><?php  echo $err?></li><?php  endforeach;?></ul></div><?php  endif;?></div><?php  endif; ?><?php  $formResubmitId = 'ReadOperatorMessage'; ?><?php   if (isset($errors['captcha']) && !isset($_POST['ResubmitCaptcha'])) : ?><input type="hidden" name="ResubmitCaptcha" value="true" /><script>$( document ).ready(function() {<?php  if (!(isset($start_data_fields['message_auto_start']) && $start_data_fields['message_auto_start'] == true)) : ?>$('#<?php  echo $formResubmitId?>').submit();<?php  endif;?>});</script><?php  endif;?><?php   $hasExtraField = false; if ($visitor->requires_username == 1 || $visitor->requires_email == 1 || $visitor->requires_phone == 1) : $hasExtraField = true;?><div class="row"><?php  endif;?><?php  if ($visitor->requires_username == 1) : ?><div class="col-xs-6 form-group"><label>Nombre*</label><input type="text" class="form-control" name="Username" value="<?php  echo htmlspecialchars($input_data->username);?>" /></div><?php  endif; ?><?php  if ($visitor->requires_phone == 1) : ?><div class="col-xs-6 form-group"><label>Teléfono*</label><input type="text" class="form-control" name="Phone" value="<?php  echo htmlspecialchars($input_data->phone);?>" placeholder="Min 8 caracteres" /></div><?php  endif; ?><?php  if ($visitor->requires_email == 1) : ?><div class="col-xs-6 form-group"><label>E-mail*</label><input type="text" class="form-control" name="Email" value="<?php  echo htmlspecialchars($input_data->email);?>" /></div><?php  endif; ?><?php  if ($visitor->requires_username == 1 || $visitor->requires_email == 1 || $visitor->requires_phone == 1) : ?></div><?php  endif;?><?php  $adminCustomFieldsMode = 'on';?><?php   if (isset($start_data_fields['custom_fields']) && $start_data_fields['custom_fields'] != '') : $customAdminfields = json_decode($start_data_fields['custom_fields'],true); if (is_array($customAdminfields)) : ?><div class="row"><?php  foreach ($customAdminfields as $key => $adminField) : if ($adminField['visibility'] == 'all' || $adminCustomFieldsMode == $adminField['visibility']) : ?><?php  if ($adminField['fieldtype'] == 'hidden' || (isset($input_data->via_hidden[$key]) && $input_data->via_hidden[$key] == 't')) : ?><?php  if (isset($input_data->via_hidden[$key]) && $input_data->via_hidden[$key] == 't') : ?><input class="form-control" type="hidden" name="via_hidden[<?php  echo $key?>]" value="t" /><?php  endif;?><?php  if (isset($input_data->via_encrypted[$key]) && $input_data->via_encrypted[$key] == 't') : ?><input class="form-control" type="hidden" name="via_encrypted[<?php  echo $key?>]" value="t" /><?php  endif;?><input class="form-control" type="hidden" name="value_items_admin[<?php  echo $key?>]" value="<?php  isset($input_data->value_items_admin[$key]) ? print htmlspecialchars($input_data->value_items_admin[$key]) : print htmlspecialchars($adminField['defaultvalue'])?>" /><?php  else : $hasExtraField = true; ?><div class="col-xs-<?php  echo htmlspecialchars($adminField['size'])?>"><div class="form-group<?php  if (isset($errors['additional_admin_'.$key])) : ?> has-error<?php  endif;?>"><label class="control-label"><?php  echo htmlspecialchars($adminField['fieldname'])?>&nbsp;<?php  $adminField['isrequired'] == 'true' ? print '*' : ''?></label><input class="form-control" type="text" name="value_items_admin[<?php  echo $key?>]" value="<?php  isset($input_data->value_items_admin[$key]) ? print htmlspecialchars($input_data->value_items_admin[$key]) : print htmlspecialchars($adminField['defaultvalue'])?>" /></div></div><?php  endif; endif; endforeach;?></div><?php  endif; endif;?><?php   $modeUserVariables = isset($modeUserVariables) ? $modeUserVariables : 'on'; if (!empty($input_data->name_items)) { $hasExtraField = true; }; foreach ($input_data->name_items as $item) : ?><input type="hidden" name="name_items[]" value="<?php  echo htmlspecialchars($item)?>" /><?php  endforeach;?><?php  if (isset($input_data->value_sizes)) : foreach ($input_data->value_sizes as $item) : ?><input type="hidden" name="value_sizes[]" value="<?php  echo htmlspecialchars($item)?>" /><?php  endforeach;endif;?><?php  if (isset($input_data->values_req)) : foreach ($input_data->values_req as $item) : ?><input type="hidden" name="values_req[]" value="<?php  echo htmlspecialchars($item)?>" /><?php  endforeach;endif;?><?php  if (isset($input_data->value_show)) : foreach ($input_data->value_show as $item) : ?><input type="hidden" name="value_show[]" value="<?php  echo htmlspecialchars($item)?>" /><?php  endforeach;endif;?><?php  if (isset($input_data->hattr)) : foreach ($input_data->hattr as $item) : ?><input type="hidden" name="hattr[]" value="<?php  echo htmlspecialchars($item)?>" /><?php  endforeach;endif;?><?php  if (isset($input_data->encattr)) : foreach ($input_data->encattr as $item) : ?><input type="hidden" name="encattr[]" value="<?php  echo htmlspecialchars($item)?>" /><?php  endforeach;endif;?><?php $hasVisibleField = false; foreach ($input_data->value_types as $key => $item) : $showField = ($input_data->value_show[$key] == $modeUserVariables || $input_data->value_show[$key] == 'b'); ($hasVisibleField = ($item == 'text' && $showField == true) ? true : $hasVisibleField); ?><input type="hidden" name="value_types[]" value="<?php  echo htmlspecialchars($item)?>" /><?php  endforeach;?><?php  if ($hasVisibleField == true) : ?><div class="row"><?php  endif;?><?php  foreach ($input_data->value_items as $key => $item) : $showField = ($input_data->value_show[$key] == $modeUserVariables || $input_data->value_show[$key] == 'b'); $visibleItem = (isset($input_data->value_types[$key]) && $input_data->value_types[$key] == 'text' && isset($input_data->name_items[$key])); ?><?php  if ($visibleItem == true && $showField == true) : ?><div class="form-group col-xs-<?php  isset($input_data->value_sizes[$key]) ? print (int)$input_data->value_sizes[$key] : print 6?><?php  if (isset($errors['additional_'.$key])) : ?> has-error<?php  endif;?>"><label class="control-label"><?php  echo htmlspecialchars($input_data->name_items[$key])?><?php  isset($input_data->values_req[$key]) && $input_data->values_req[$key] == 't' ? print '*' : ''?></label><?php  endif;?><input class="form-control" type="<?php  isset($input_data->value_types[$key]) && $showField == true ? print htmlspecialchars($input_data->value_types[$key]) : print 'hidden' ?>" name="value_items[]" value="<?php  echo htmlspecialchars($item)?>" /><?php  if ($visibleItem == true && $showField == true) : ?></div><?php  endif;?><?php  endforeach;?><?php  if ($hasVisibleField == true) : ?></div><?php  endif;?><?php  if ($department === false) : ?><?php   $filter = array('filter' => array('disabled' => 0, 'hidden' => 0)); if (isset($input_data->departament_id_array)) { $filter['filterin']['id'] = $input_data->departament_id_array; } $filter['sort'] = 'sort_priority ASC, name ASC'; $departments = erLhcoreClassModelDepartament::getList($filter); if (count($departments) > 1) : $hasExtraField = true;?><?php  if (isset($input_data->departament_id_array)) : foreach ($input_data->departament_id_array as $definedDep) : ?><input type="hidden" name="DepartmentIDDefined[]" value="<?php  echo $definedDep?>" /><?php  endforeach; endif; ?><?php  if (!isset($departmentsOptions['hide_department']) || $departmentsOptions['hide_department'] == false) : ?><div class="form-group<?php  if (isset($errors['department'])) : ?> has-error<?php  endif;?>"><label class="control-label"><?php  if (isset($theme) && $theme !== false && $theme->department_title != '') : ?><?php  echo htmlspecialchars($theme->department_title)?><?php  else : ?>Departamento<?php  endif;?></label><select class="form-control" name="DepartamentID" id="id_DepartamentID"><?php  if (isset($theme) && $theme !== false && $theme->department_select != '') : ?><option value="-1"><?php  echo htmlspecialchars($theme->department_select)?></option><?php  endif;?><?php  $departments = erLhcoreClassDepartament::sortByStatus($departments); foreach ($departments as $departament) : $isOnline = erLhcoreClassChat::isOnline($departament->id,false,array('ignore_user_status'=> (int)'0', 'online_timeout' => (int)'300')); ?><?php  if (($departament->visible_if_online == 1 && $isOnline === true) || $departament->visible_if_online == 0) : ?><option data-attr-online="<?php  if ($isOnline === false) : ?>false<?php  else : ?>true<?php  endif;?>" <?php  if ($isOnline === false) : ?>class="offline-dep"<?php  endif;?> value="<?php  echo $departament->id?>" <?php  isset($input_data->departament_id) && $input_data->departament_id == $departament->id ? print 'selected="selected"' : '';?> ><?php  echo htmlspecialchars($departament->name)?><?php  if ($isOnline === false) : ?>&nbsp;&nbsp;--=Desconectado=--<?php  endif;?></option><?php  endif;?><?php  endforeach; ?></select></div><?php  endif; endif; ?><?php  endif;?><input type="hidden" name="user_timezone" value="" /><script>$(document).ready(function() {Date.prototype.stdTimezoneOffset = function() {var jan = new Date(this.getFullYear(), 0, 1);var jul = new Date(this.getFullYear(), 6, 1);return Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());};Date.prototype.dst = function() {return this.getTimezoneOffset() < this.stdTimezoneOffset();};var today = new Date();var timeZoneOffset = 0;if (today.dst()) {timeZoneOffset = today.getTimezoneOffset();} else {timeZoneOffset = today.getTimezoneOffset()-60;};$('input[name=user_timezone]').val(((timeZoneOffset)/60) * -1);});</script><input type="hidden" name="askQuestion" value="1" /><input type="hidden" value="<?php  echo htmlspecialchars($input_data->operator);?>" name="operator" /><input type="hidden" value="<?php  echo htmlspecialchars($referer);?>" name="URLRefer"/><input type="hidden" value="<?php  echo htmlspecialchars($referer_site);?>" name="r"/><?php   ?><textarea class="form-control form-group <?php  if ($hasExtraField !== true) : ?>btop-reset btrad-reset mb0<?php  endif;?>" placeholder="Escriba su mensaje aquí y presione enter para enviar..." id="id_Question" name="Question"><?php  echo htmlspecialchars($input_data->question);?></textarea><?php  if ($hasExtraField === true) : ?><div class="btn-group" role="group" aria-label="..."><input type="submit" name="askQuestionAction" id="idaskQuestionAction" value="Enviar" class="btn btn-default btn-sm"/><?php  endif;?><?php   ?><?php  if ($hasExtraField === true) : ?></div><?php  endif;?><?php  if ($hasExtraField === true) : ?><input type="hidden" value="1" id="hasFormExtraField"/><?php  endif;?></form><script><?php  if ($hasExtraField == false && isset($start_data_fields['message_auto_start']) && $start_data_fields['message_auto_start'] == true && isset($start_data_fields['message_auto_start_key_press']) && $start_data_fields['message_auto_start_key_press'] == true) : ?>$('#id_Question').on('keydown', function (e) {if ($( "#ReadOperatorMessage").attr("key-up-started") != 1) {$( "#ReadOperatorMessage").attr("key-up-started",1);$( "#ReadOperatorMessage").submit();}});<?php  endif;?>var formSubmitted = false;jQuery('#id_Question').bind('keydown', 'return', function (evt){if (formSubmitted == false) {$( "#ReadOperatorMessage" ).submit();<?php  if (!isset($start_data_fields['message_auto_start']) || $start_data_fields['message_auto_start'] == false) : ?>formSubmitted = true;jQuery('#id_Question').attr('readonly','readonly');<?php  endif;?>};return false;});<?php  if ($playsound == true) : ?>$(function() {lhinst.playInvitationSound();});<?php  endif; ?></script>