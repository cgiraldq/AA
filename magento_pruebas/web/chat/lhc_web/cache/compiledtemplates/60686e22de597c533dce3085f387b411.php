<div class="row"><div class="col-sm-7 chat-main-left-column" id="chat-main-column-<?php  echo $chat->id;?>"><a title="Mostrar/Ocultar columna derecha" href="#" class="material-icons collapse-right" onclick="lhinst.processCollapse('<?php  echo $chat->id;?>')">chevron_right</a><?php   ?><div class="message-block"><div class="msgBlock msgBlock-admin" id="messagesBlock-<?php  echo $chat->id?>"><?php $LastMessageID = 0; $messages = erLhcoreClassChat::getChatMessages($chat->id); ?><?php  if ($chat->status != erLhcoreClassModelChat::STATUS_CHATBOX_CHAT) : $lastOperatorChanged = false; $lastOperatorId = false; foreach ($messages as $msg) : if ($lastOperatorId !== false && $lastOperatorId != $msg['user_id']) { $lastOperatorChanged = true; } else { $lastOperatorChanged = false; } $lastOperatorId = $msg['user_id']; if ($msg['user_id'] == -1) : ?><div class="message-row system-response" id="msg-<?php  echo $msg['id']?>"><div class="msg-date"><?php  echo erLhcoreClassChat::formatDate($msg['time']);?></div><i><span class="usr-tit sys-tit">Asistente del sistema</span><?php  echo erLhcoreClassBBCode::make_clickable(htmlspecialchars($msg['msg']))?></i></div><?php  else : ?><div class="message-row<?php  echo $msg['user_id'] == 0 ? ' response' : ' message-admin'.($lastOperatorChanged == true ? ' operator-changes' : '') ?>" data-op-id="<?php  echo $msg['user_id']?>" id="msg-<?php  echo $msg['id']?>"><div class="msg-date"><?php  echo erLhcoreClassChat::formatDate($msg['time']);?></div><span class="usr-tit<?php  echo $msg['user_id'] == 0 ? ' vis-tit' : ' op-tit'?>"><?php  echo $msg['user_id'] == 0 ? '<i class="material-icons chat-operators mi-fs15 mr-0">face</i>'.htmlspecialchars($chat->nick) : '<i class="material-icons chat-operators mi-fs15 mr-0">account_box</i>'.htmlspecialchars($msg['name_support']) ?></span><?php  echo erLhcoreClassBBCode::make_clickable(htmlspecialchars($msg['msg']))?></div><?php  endif;?><?php  endforeach; ?><?php  else : ?><?php  foreach ($messages as $msg ) : ?><div class="message-row<?php  echo $msg['user_id'] == 0 ? ' response' : ' message-admin'?>" id="msg-<?php  echo $msg['id']?>"><div class="msg-date"><?php  echo erLhcoreClassChat::formatDate($msg['time']);?></div><span class="usr-tit<?php  echo $msg['user_id'] == 0 ? ' vis-tit' : ' op-tit'?>"><?php  echo $msg['user_id'] == 0 ? htmlspecialchars($msg['name_support']) : htmlspecialchars($chat->nick) ?></span><?php  echo erLhcoreClassBBCode::make_clickable(htmlspecialchars($msg['msg']))?></div><?php  endforeach; ?><?php  endif;?><?php  if (isset($msg)) { $LastMessageID = $msg['id'];} ?><?php  if ($chat->user_status == 1) : ?><div class="message-row system-response"><i><span class="usr-tit sys-tit">Asistente del sistema</span>Visitor has left the chat!</i></div><?php  elseif ($chat->user_status == 0) : ?><div class="message-row system-response"><i><span class="usr-tit sys-tit">Asistente del sistema</span>Visitor has joined the chat!</i></div><?php  endif;?></div></div><div class="user-is-typing" id="user-is-typing-<?php  echo $chat->id?>">El usuario está escribiendo...</div><textarea class="form-control form-group" rows="4" <?php  if ($chat->status == erLhcoreClassModelChat::STATUS_CLOSED_CHAT) : ?>readonly="readonly"<?php  endif;?> name="ChatMessage" id="CSChatMessage-<?php  echo $chat->id?>"></textarea><script type="text/javascript">jQuery('#CSChatMessage-<?php  echo $chat->id?>').bind('keydown', 'return', function (evt){lhinst.addmsgadmin('<?php  echo $chat->id?>');return false;});jQuery('#CSChatMessage-<?php  echo $chat->id?>').bind('keyup', 'up', function (evt){lhinst.editPrevious('<?php  echo $chat->id?>');});lhinst.initTypingMonitoringAdmin('<?php  echo $chat->id?>');lhinst.afterAdminChatInit('<?php  echo $chat->id?>');</script><div class="form-group"><div class="form-group" id="action-block-row-<?php  echo $chat->id?>"><div class="send-row<?php  if ($chat->status == erLhcoreClassModelChat::STATUS_CLOSED_CHAT) : ?> hide<?php  endif;?>"><div class="btn-group btn-group-justified"><a href="#" class="btn btn-default material-icons" onclick="return lhinst.addmsgadmin('<?php  echo $chat->id?>')" title="Enviar">&#xE163;</a><?php  $speech_action_enabled = true;?><?php  if ($speech_action_enabled == true && erLhcoreClassUser::instance()->hasAccessTo('lhspeech','use')) : ?><a class="btn btn-default" href="#" id="mic-chat-<?php  echo $chat->id?>" onclick="return lhc.methodCall('lhc.speak','listen',{'chat_id':'<?php  echo $chat->id?>'})"><i class="material-icons">mic_none</i><span class="mic-lang"></span></a><?php  endif;?><?php  $translation_action_enabled = true;?><?php  if ($translation_action_enabled == true && erLhcoreClassUser::instance()->hasAccessTo('lhtranslation','use')) : ?><?php  $dataChatTranslation = !isset($dataChatTranslation) ? array (0 => false,'translation_handler' => 'bing','enable_translations' => false,'bing_client_id' => '','bing_client_secret' => '','google_api_key' => '',) : $dataChatTranslation; ?><?php  if ($dataChatTranslation['enable_translations'] && $dataChatTranslation['enable_translations'] == true) : ?><a class="btn btn-default translate-button-<?php  echo $chat->id?><?php  if ($chat->chat_locale != '' && $chat->chat_locale_to != '') :?> btn-success<?php  endif;?> material-icons" title="Auto traducir" id="start-trans-btn-<?php  echo $chat->id?>" onclick="return lhc.methodCall('lhc.translation','startTranslation',{'btn':$(this),'chat_id':'<?php  echo $chat->id?>'})">language</a><?php  endif;?><?php  endif;?><?php  $chat_part_canned_messages_action_enabled = true;?><?php  if ($chat_part_canned_messages_action_enabled == true) : ?><a title="Enviar mensaje prederteminado de retraso inmediatamente" href="#" class="btn btn-default material-icons" onclick="return lhinst.sendCannedMessage('<?php  echo $chat->id?>',$(this))">mail</a><?php  endif;?></div></div><?php  if ($chat->status == erLhcoreClassModelChat::STATUS_CLOSED_CHAT) : ?><input type="button" value="Reabrir chat" class="btn btn-default" data-id="<?php  echo $chat->id?>" onclick="lhinst.reopenchat($(this))" /><?php  endif;?></div><?php  $chat_part_canned_messages_action_enabled = true;?><?php  if ($chat_part_canned_messages_action_enabled == true) : ?><div class="row"><div class="col-xs-8"><select class="form-control" name="CannedMessage-<?php  echo $chat->id?>" id="id_CannedMessage-<?php  echo $chat->id?>"><option value="">Seleccione un mensaje predefinido</option><?php   $nameSupport = (string)erLhcoreClassUser::instance()->getUserData(true)->name_support; $replaceArray = array( '{nick}' => $chat->nick, '{email}' => $chat->email, '{phone}' => $chat->phone, '{operator}' => $nameSupport ); $additionalData = $chat->additional_data_array; foreach ($additionalData as $row) { if (isset($row->identifier) && $row->identifier != ''){ $replaceArray['{'.$row->identifier.'}'] = $row->value; } } erLhcoreClassChatEventDispatcher::getInstance()->dispatch('chat.workflow.canned_message_replace',array('chat' => $chat, 'replace_array' => & $replaceArray)); foreach (erLhcoreClassModelCannedMsg::getCannedMessages($chat->dep_id,erLhcoreClassUser::instance()->getUserID()) as $item) : $item->setReplaceData($replaceArray); ?><option data-msg="<?php  echo htmlspecialchars($item->msg_to_user)?>" data-delay="<?php  echo $item->delay?>" value="<?php  echo $item->id?>"><?php  echo htmlspecialchars($item->message_title)?></option><?php  endforeach;?></select></div><div class="col-xs-4 sub-action-chat"><a title="Llene el campo con un mensaje predefinido" href="#" onclick="$('#CSChatMessage-<?php  echo $chat->id?>').val(($('#id_CannedMessage-<?php  echo $chat->id?>').val() > 0) ? $('#id_CannedMessage-<?php  echo $chat->id?>').find(':selected').attr('data-msg') : '');return false;" class="btn btn-default"><i class="material-icons mr-0">mode_edit</i></a></div></div><?php  endif;?></div></div><div class="col-sm-5 chat-main-right-column" id="chat-right-column-<?php  echo $chat->id;?>"><div role="tabpanel"><ul class="nav nav-pills" role="tablist" id="chat-tab-items-<?php  echo $chat->id?>"><?php   $chatTabsOrder = array( 'information_tab_tab', 'chat_translation_tab', 'operator_remarks_tab', 'information_tab_user_files_tab', 'operator_screenshot_tab', 'footprint_tab_tab', 'map_tab_tab', 'online_user_info_tab', 'extension_chat_tab_multiinclude', ); $chatTabsOrderDefault = 'information_tab_tab'; ?><?php   foreach ($chatTabsOrder as $tabItem) : ?><?php  if ($tabItem == 'information_tab_tab') : ?><li role="presentation"<?php  if ($chatTabsOrderDefault == 'information_tab_tab') print ' class="active"';?>><a href="#main-user-info-tab-<?php  echo $chat->id?>" aria-controls="main-user-info-tab-<?php  echo $chat->id?>" role="tab" data-toggle="tab" title="Visitante"><i class="material-icons mr-0">info_outline</i></a></li><?php  elseif ($tabItem == 'chat_translation_tab') : ?><?php  $chat_translation_tab_enabled = true;?><?php  if ($chat_translation_tab_enabled == true && erLhcoreClassUser::instance()->hasAccessTo('lhtranslation','use')) : ?><?php  $dataChatTranslation = !isset($dataChatTranslation) ? array (0 => false,'translation_handler' => 'bing','enable_translations' => false,'bing_client_id' => '','bing_client_secret' => '','google_api_key' => '',) : $dataChatTranslation; ?><?php  if ($dataChatTranslation['enable_translations'] && $dataChatTranslation['enable_translations'] == true) : ?><li role="presentation"<?php  if ($chatTabsOrderDefault == 'chat_translation_tab') print ' class="active"';?>><a href="#main-user-info-translation-<?php  echo $chat->id?>" aria-controls="main-user-info-translation-<?php  echo $chat->id?>" title="Traducción automática" role="tab" data-toggle="tab"><i class="material-icons mr-0">language</i></a></li><?php  endif;?><?php  endif;?><?php  elseif ($tabItem == 'operator_remarks_tab') : ?><?php  $operator_remarks_tab_enabled = true;?><?php  if ($operator_remarks_tab_enabled == true) : ?><li role="presentation"<?php  if ($chatTabsOrderDefault == 'operator_remarks_tab') print ' class="active"';?>><a href="#main-user-info-remarks-<?php  echo $chat->id?>" aria-controls="main-user-info-remarks-<?php  echo $chat->id?>" role="tab" data-toggle="tab" title="Observaciones"><i class="material-icons mr-0">mode_edit</i></a></li><?php  endif;?><?php  elseif ($tabItem == 'information_tab_user_files_tab') : ?><?php  $fileData = (array)erLhcoreClassModelChatConfig::fetch('file_configuration')->data?><?php  if ( isset($fileData['active_admin_upload']) && $fileData['active_admin_upload'] == true && erLhcoreClassUser::instance()->hasAccessTo('lhfile','use_operator') ) : ?><?php  $information_tab_user_files_tab_enabled = true;?><?php  if ($information_tab_user_files_tab_enabled == true) : ?><li role="presentation"<?php  if ($chatTabsOrderDefault == 'information_tab_user_files_tab') print ' class="active"';?>><a href="#main-user-info-files-<?php  echo $chat->id?>" aria-controls="main-user-info-files-<?php  echo $chat->id?>" title="Archivos" role="tab" data-toggle="tab"><i class="material-icons mr-0">attach_file</i></a></li><?php  endif;?><?php  endif; ?><?php  elseif ($tabItem == 'operator_screenshot_tab') : ?><?php  $operator_screenshot_tab_enabled = true;?><?php  if ($operator_screenshot_tab_enabled == true && erLhcoreClassUser::instance()->hasAccessTo('lhchat','take_screenshot')) : ?><li role="presentation"<?php  if ($chatTabsOrderDefault == 'operator_screenshot_tab') print ' class="active"';?>><a href="#main-user-info-screenshot-<?php  echo $chat->id?>" aria-controls="main-user-info-screenshot-<?php  echo $chat->id?>" title="Pantalla" role="tab" data-toggle="tab"><i class="material-icons mr-0">photo_camera</i></a></li><?php  endif;?><?php  elseif ($tabItem == 'footprint_tab_tab') : ?><?php  $chat_chat_tabs_footprint_tab_tab_enabled = true; ?><?php  if ($chat_chat_tabs_footprint_tab_tab_enabled == true && '0' == 1) : ?><li role="presentation"<?php  if ($chatTabsOrderDefault == 'footprint_tab_tab') print ' class="active"';?>><a href="#footprint-tab-chat-<?php  echo $chat->id?>" aria-controls="footprint-tab-chat-<?php  echo $chat->id?>" role="tab" data-toggle="tab" title="Huella/Footprint"><i class="material-icons mr-0">directions_walk</i></a></li><?php  endif;?><?php  elseif ($tabItem == 'map_tab_tab') : ?><?php  $information_tab_map_tab_tab_enabled = true;?><?php  if ($information_tab_map_tab_tab_enabled == true) : ?><li role="presentation"<?php  if ($chatTabsOrderDefault == 'map_tab_tab') print ' class="active"';?>><a href="#map-tab-chat-<?php  echo $chat->id?>" title="Mapa" aria-controls="map-tab-chat-<?php  echo $chat->id?>" role="tab" data-toggle="tab"><i class="material-icons mr-0">place</i></a></li><?php  endif;?><?php  elseif ($tabItem == 'online_user_info_tab') : ?><?php  if (($online_user = $chat->online_user) !== false) : ?><?php  $information_tab_online_user_info_tab_enabled = true;?><?php  if ($information_tab_online_user_info_tab_enabled == true) : ?><li role="presentation"<?php  if ($chatTabsOrderDefault == 'online_user_info_tab') print ' class="active"';?>><a href="#online-user-info-tab-<?php  echo $chat->id?>" aria-controls="online-user-info-tab-<?php  echo $chat->id?>" role="tab" data-toggle="tab" title="Información de navegación del usuario"><i class="material-icons mr-0">face</i></a></li><?php  endif;?><?php  $information_tab_online_user_info_tab_chats_enabled = true?><?php  if ($information_tab_online_user_info_tab_chats_enabled == true) : ?><li role="presentation"><a href="#online-user-info-chats-tab-<?php  echo $chat->id?>" aria-controls="online-user-info-chats-tab-<?php  echo $chat->id?>" role="tab" data-toggle="tab" title="Chats"><i class="material-icons mr-0">chat</i></a></li><?php  endif;?><?php  endif;?><?php  elseif ($tabItem == 'extension_chat_tab_multiinclude') : ?><?php   ?><?php  endif;?><?php  endforeach; ?></ul><div class="tab-content"><div role="tabpanel" class="tab-pane<?php  if ($chatTabsOrderDefault == 'information_tab_tab') print ' active';?>" id="main-user-info-tab-<?php  echo $chat->id?>"><div class="pull-right operator-info pt5"><i class="material-icons mr-0<?php  if ($chat->fbst == 1) : ?> up-voted<?php  endif;?>">thumb_up</i><i class="material-icons<?php  if ($chat->fbst == 2) : ?> down-voted<?php  endif;?>">thumb_down</i><span class="pull-right label label-default fs12<?php  if (erLhcoreClassUser::instance()->hasAccessTo('lhchat','canchangechatstatus')) : ?> action-image<?php  endif?>" id="chat-status-text-<?php  echo $chat->id?>" <?php  if (erLhcoreClassUser::instance()->hasAccessTo('lhchat','canchangechatstatus')) : ?>title="Haga clic para cambiar estado" onclick="return lhc.revealModal({'url':WWW_DIR_JAVASCRIPT +'chat/changestatus/<?php  echo $chat->id?>'})"<?php  endif;?>><?php  if ($chat->status == erLhcoreClassModelChat::STATUS_PENDING_CHAT) : ?>Chat pendiente<?php  elseif ($chat->status == erLhcoreClassModelChat::STATUS_ACTIVE_CHAT) : ?>Chat activo<?php  elseif ($chat->status == erLhcoreClassModelChat::STATUS_CLOSED_CHAT) : ?>Chat cerrado<?php  elseif ($chat->status == erLhcoreClassModelChat::STATUS_CHATBOX_CHAT) : ?>Chatbox chat<?php  elseif ($chat->status == erLhcoreClassModelChat::STATUS_OPERATORS_CHAT) : ?>Operadores del chat<?php  endif;?></span></div><div><a onclick="return lhc.revealModal({'iframe':true,'height':350,'url':WWW_DIR_JAVASCRIPT +'chat/modifychat/<?php  echo $chat->id?>'})" title="Editar información principal del chat" href="#"><i class="material-icons mr-0">mode_edit</i></a><?php  if (!isset($hideActionBlock)) : ?><a class="material-icons mr-0" data-title="<?php  echo htmlspecialchars($chat->nick,ENT_QUOTES);?>" onclick="lhinst.startChatCloseTabNewWindow('<?php  echo $chat->id;?>',$('#tabs'),$(this).attr('data-title'))" title="Abrir en una ventana nueva">open_in_new</a><a class="material-icons mr-0" onclick="lhinst.removeDialogTab('<?php  echo $chat->id?>',$('#tabs'),true)" title="Cerrar diálogo">remove_circle_outline</a><?php  if ($chat->user_id == erLhcoreClassUser::instance()->getUserID() || erLhcoreClassUser::instance()->hasAccessTo('lhchat','allowcloseremote')) : ?><a class="material-icons mr-0" onclick="lhinst.closeActiveChatDialog('<?php  echo $chat->id?>',$('#tabs'),true)" title="Cerrar chat">close</a><?php  endif;?><?php  if (erLhcoreClassUser::instance()->hasAccessTo('lhchat','deleteglobalchat') || (erLhcoreClassUser::instance()->hasAccessTo('lhchat','deletechat') && $chat->user_id == erLhcoreClassUser::instance()->getUserID())) : ?><a class="material-icons mr-0" onclick="lhinst.deleteChat('<?php  echo $chat->id?>',$('#tabs'),true)" title="Eliminar chat">delete</a><?php  endif ?><?php  $chat_chat_tabs_actions_transfer_enabled = true;?><?php  if ($chat_chat_tabs_actions_transfer_enabled == true && erLhcoreClassUser::instance()->hasAccessTo('lhchat', 'allowtransfer')) : ?><a class="material-icons mr-0" onclick="lhc.revealModal({'url':WWW_DIR_JAVASCRIPT +'chat/transferchat/<?php  echo $chat->id?>'})" title="Transferir chat">supervisor_account</a><?php  endif; ?><?php  if (erLhcoreClassUser::instance()->hasAccessTo('lhchat','allowblockusers')) : ?><?php  $chat_chat_tabs_actions_blockuser_enabled = true;?><?php  if ($chat_chat_tabs_actions_blockuser_enabled == true) : ?><a class="material-icons mr-0" data-title="¿Está seguro?" onclick="lhinst.blockUser('<?php  echo $chat->id?>',$(this).attr('data-title'))" title="Bloquear usuario">block</a><?php  endif;?><?php  endif;?><a class="material-icons mr-0 <?php  if ($chat->mail_send == 1) : ?>icon-mail-send<?php  endif; ?>" onclick="lhc.revealModal({'iframe':true,'height':500,'url':WWW_DIR_JAVASCRIPT +'chat/sendmail/<?php  echo $chat->id?>'})" title="<?php  if ($chat->mail_send == 1) : ?>El correo ha sido enviado<?php  else : ?>Enviar correo<?php  endif;?>">mail</a><a class="material-icons mr-0" title="Redirigir usuario al formulario de contacto." onclick="lhinst.redirectContact('<?php  echo $chat->id;?>','¿Está seguro?')" >reply</a><a target="_blank" href="/chat/lhc_web/index.php/site_admin/chat/printchatadmin/<?php  echo $chat->id?>" class="material-icons mr-0" title="Imprimir">print</a><?php  $chat_chat_tabs_actions_attatch_file_enabled = true;?><?php  if ($chat_chat_tabs_actions_attatch_file_enabled == true) : ?><a class="material-icons mr-0" onclick="return lhc.revealModal({'iframe':true,'height':500,'url':WWW_DIR_JAVASCRIPT +'file/attatchfile/<?php  echo $chat->id?>'})" title="Adjuntar archivo subido">attach_file</a><?php  endif;?><?php  if (erLhcoreClassUser::instance()->hasAccessTo('lhchat','allowredirect')) : ?><a class="material-icons mr-0" onclick="lhinst.redirectToURL('<?php  echo $chat->id?>','Por favor ingrese una URL')" title="re-dirigir usuario a otra URL">link</a><?php  endif;?><?php  $chat_chat_tabs_actions_speech_enabled = true;?><?php  if ($chat_chat_tabs_actions_speech_enabled == true && erLhcoreClassUser::instance()->hasAccessTo('lhspeech','change_chat_recognition')) : ?><a class="material-icons mr-0" title="Escoger otro idioma de reconocimiento predeterminado" onclick="lhc.revealModal({'url':'/chat/lhc_web/index.php/site_admin/speech/setchatspeechlanguage/<?php  echo $chat->id?>'})">mic_none</a><?php  endif;?><?php  $chat_chat_tabs_actions_cobrowse_enabled = true;?><?php  if ($chat_chat_tabs_actions_cobrowse_enabled == true && erLhcoreClassUser::instance()->hasAccessTo('lhcobrowse', 'browse')) : ?><a title="Compartir pantalla" class="material-icons" href="#" onclick="return lhinst.startCoBrowse('<?php  echo $chat->id?>')">visibility</a><?php  endif;?><?php   ?><?php  else : ?><a class="material-icons mr-0" target="_blank" href="/chat/lhc_web/index.php/site_admin/chatarchive/printchatadmin/<?php  echo $archive->id?>/<?php  echo $chat->id?>">print</a><a class="material-icons mr-0" onclick="return lhc.revealModal({'iframe':true,'height':500,'url':WWW_DIR_JAVASCRIPT +'chatarchive/sendmail/<?php  echo $archive->id?>/<?php  echo $chat->id?>'})">mail</a><?php  endif; ?></div><table class="table table-condensed"><?php  if ( $chat->department !== false ) : ?><tr><td>Departamento</td><td><?php  echo htmlspecialchars($chat->department);?></td></tr><?php  endif;?><?php  if ($chat->product !== false) : ?><tr><td>Producto</td><td><?php  echo htmlspecialchars($chat->product);?></td></tr><?php  endif;?><?php  if ( !empty($chat->country_code) ) : ?><tr><td>País</td><td><img src="/chat/lhc_web/design/defaulttheme/images/flags/<?php  echo $chat->country_code?>.png" alt="<?php  echo htmlspecialchars($chat->country_name)?>" title="<?php  echo htmlspecialchars($chat->country_name)?>" /></td></tr><?php  endif;?><?php  if ( !empty($chat->user_tz_identifier) ) : ?><tr><td>Zona horaria</td><td><?php  echo htmlspecialchars($chat->user_tz_identifier)?>, <?php  echo htmlspecialchars($chat->user_tz_identifier_time)?></td></tr><?php  endif;?><?php  if ( !empty($chat->city) ) : ?><tr><td>Ciudad</td><td><?php  echo htmlspecialchars($chat->city);?></td></tr><?php  endif;?><tr><td>IP</td><td><?php  echo $chat->ip?></td></tr><?php  if (!empty($chat->referrer)) : ?><tr><td>Página</td><td><div class="page-url"><span><?php  echo $chat->referrer != '' ? '<a target="_blank" title="' . htmlspecialchars($chat->referrer) . '" href="' .htmlspecialchars($chat->referrer). '">'.htmlspecialchars($chat->referrer).'</a>' : ''?></span></div></td></tr><?php  endif;?><?php  if (!empty($chat->session_referrer)) : ?><tr><td>Vino de</td><td><div class="page-url"><span><?php  echo $chat->session_referrer != '' ? '<a target="_blank" title="' . htmlspecialchars($chat->session_referrer) . '" href="' . htmlspecialchars($chat->session_referrer) . '">'.htmlspecialchars($chat->session_referrer).'</a>' : ''?></span></div></td></tr><?php  endif;?><tr><td>ID</td><td><?php  echo $chat->id;?></td></tr><?php  if (!empty($chat->email)) : ?><tr><td>E-mail</td><td><a href="mailto:<?php  echo $chat->email?>"><?php  echo $chat->email?></a></td></tr><?php  endif;?><?php  if (!empty($chat->phone)) : ?><tr><td>Teléfono</td><td><?php  echo htmlspecialchars($chat->phone)?></td></tr><?php  endif;?><?php   ?><?php  if (!empty($chat->additional_data)) : ?><tr><td><a class="btn btn-default btn-xs" onclick="lhinst.addRemoteCommand('<?php  echo $chat->id?>','lhc_cfrefresh');$('#custom-data-td-<?php  echo $chat->id?>').text('...')" title="Actualizar"><i class="material-icons mr-0">&#xE5D5;</i></a>&nbsp;Datos adicionales</td><td id="custom-data-td-<?php  echo $chat->id?>"><?php  if (is_array($chat->additional_data_array)) : ?><ul class="circle mb0"><?php  foreach ($chat->additional_data_array as $addItem) : ?><li><?php  echo htmlspecialchars($addItem->key)?> - <?php  echo htmlspecialchars($addItem->value)?><?php  if (isset($addItem->h) && $addItem->h == true) : ?>&nbsp;<i class="material-icons" title="Hidden field">visibility_off</i><?php  endif;?></li><?php  endforeach;?></ul><?php  else : ?><?php  echo htmlspecialchars($chat->additional_data)?><?php  endif;?></td></tr><?php  endif;?><tr><td>Creado</td><td><?php  echo date(erLhcoreClassModule::$dateDateHourFormat,$chat->time)?></td></tr><?php  if ($chat->user_closed_ts > 0 && $chat->user_status == 1) : ?><tr><td>El usuario se ha ido</td><td><?php  echo $chat->user_closed_ts_front?></td></tr><?php  endif;?><?php  if ($chat->wait_time > 0) : ?><tr><td>Esperó</td><td><?php  echo $chat->wait_time_front?></td></tr><?php  endif;?><?php  if ($chat->chat_duration > 0) : ?><tr><td>Duración del chat</td><td><?php  echo $chat->chat_duration_front?></td></tr><?php  endif;?><tr><td>Duración del chat</td><td><?php  echo $chat->chat_duration_front?></td></tr><?php  if ($chat->status == erLhcoreClassModelChat::STATUS_OPERATORS_CHAT) : ?><tr><td>Chat entre los operadores, iniciador de chat</td><td><?php  echo htmlspecialchars($chat->nick)?></td></tr><?php  endif;?><tr><td>Propietario del chat</td><td><?php  $user = $chat->getChatOwner(); if ($user !== false) : ?><?php  echo htmlspecialchars($user->name.' '.$user->surname)?><?php  endif; ?></td></tr></table></div><div role="tabpanel" class="tab-pane<?php  if ($chatTabsOrderDefault == 'operator_remarks_tab') print ' active';?>" id="main-user-info-remarks-<?php  echo $chat->id?>"><?php  $operator_remarks_enabled = true;?><?php  if ($operator_remarks_enabled == true) : ?><div id="remarks-status-<?php  echo $chat->id?>" class="material-icons pb10 success-color">mode_edit</div><div><textarea class="form-control mh150" <?php  if (!isset($hideActionBlock)) : ?>onkeyup="lhinst.saveRemarks('<?php  echo $chat->id?>')"<?php  else : ?>readonly<?php  endif;?> id="ChatRemarks-<?php  echo $chat->id?>"><?php  echo htmlspecialchars($chat->remarks)?></textarea></div><?php  endif;?></div><?php  if ( isset($fileData['active_admin_upload']) && $fileData['active_admin_upload'] == true && erLhcoreClassUser::instance()->hasAccessTo('lhfile','use_operator') ) : ?><div role="tabpanel" class="tab-pane<?php  if ($chatTabsOrderDefault == 'information_tab_user_files_tab') print ' active';?>" id="main-user-info-files-<?php  echo $chat->id?>"><div><input type="button" value="Actualizar" class="btn btn-default" onclick="lhinst.updateChatFiles('<?php  echo $chat->id?>')" /><ul id="chat-files-list-<?php  echo $chat->id?>"><?php  foreach (erLhcoreClassChat::getList(array('filter' => array('chat_id' => $chat->id)),'erLhcoreClassModelChatFile','lh_chat_file') as $file) : ?><li id="file-id-<?php  echo $file->id?>"><a title="Borrar archivo" onclick="return lhinst.deleteChatfile('<?php  echo $file->id?>')" class="material-icons">delete</a><a href="/chat/lhc_web/index.php/site_admin/file/downloadfile/<?php  echo $file->id?>/<?php  echo $file->security_hash?>" class="link" target="_blank"><?php  if ($file->user_id == 0) : ?>Enviado por el Cliente<?php  else : ?>Enviado por el Operador<?php  endif;?> - <?php  echo htmlspecialchars($file->upload_name).' ['.$file->extension.']'?></a></li><?php  endforeach;?></ul></div><div class="form-group"><input id="fileupload-<?php  echo $chat->id?>" class="fs12" type="file" name="files[]" multiple></div><div class="drop-zone form-group" id="drop-zone-<?php  echo $chat->id?>"><div class="drop-title">Coloca tus archivos aquí.</div></div><script>lhinst.addFileUpload({ft_msg:'No es un tipo de archivo aceptado',fs_msg:'El tamaño del archivo es muy grande',chat_id:'<?php  echo $chat->id?>',fs:<?php  echo $fileData['fs_max']*1024?>,ft_op:/(\.|\/)(<?php  echo $fileData['ft_op']?>)$/i});</script></div><?php  endif; ?><?php  $chat_translation_enabled = true;?><?php  if ($chat_translation_enabled == true && erLhcoreClassUser::instance()->hasAccessTo('lhtranslation','use')) : ?><?php   if ($dataChatTranslation['enable_translations'] && $dataChatTranslation['enable_translations'] == true) : ?><div role="tabpanel" class="tab-pane<?php  if ($chatTabsOrderDefault == 'chat_translation_tab') print ' active';?>" id="main-user-info-translation-<?php  echo $chat->id?>"><div class="row"><div class="col-xs-6"><div class="form-group"><label>Idioma del visitante</label><?php  echo erLhcoreClassRenderHelper::renderCombobox( array ( 'input_name' => 'chat_locale_'.$chat->id, 'optional_field' => 'Detectado automáticamente', 'selected_id' => $chat->chat_locale, 'css_class' => 'form-control', 'list_function' => 'erLhcoreClassTranslate::getSupportedLanguages' )); ?></div></div><div class="col-xs-6"><div class="form-group"><label>Mi idioma</label><?php  echo erLhcoreClassRenderHelper::renderCombobox( array ( 'input_name' => 'chat_locale_to_'.$chat->id, 'optional_field' => 'Detectado automáticamente', 'selected_id' => $chat->chat_locale_to, 'css_class' => 'form-control', 'list_function' => 'erLhcoreClassTranslate::getSupportedLanguages' )); ?></div></div></div><div class="btn-group form-group" role="group" aria-label="..."><input type="button" value="Auto traducir" class="translate-button-<?php  echo $chat->id?> btn btn-default<?php  if ($chat->chat_locale != '' && $chat->chat_locale_to != '') :?> btn-success<?php  endif;?>" data-loading-text="Traduciendo..." onclick="return lhc.methodCall('lhc.translation','startTranslation',{'btn':$(this),'chat_id':'<?php  echo $chat->id?>'})" /></div></div><?php  endif;?><?php  endif;?><?php  $operator_screenshot_enabled = true ?><?php  if ($operator_screenshot_enabled == true && erLhcoreClassUser::instance()->hasAccessTo('lhchat','take_screenshot')) : ?><div role="tabpanel" class="tab-pane<?php  if ($chatTabsOrderDefault == 'operator_screenshot_tab') print ' active';?>" id="main-user-info-screenshot-<?php  echo $chat->id?>"><div class="btn-group" role="group" aria-label="..."><input type="button" value="Capturar pantalla del usuario" class="btn btn-default" onclick="lhinst.addRemoteCommand('<?php  echo $chat->id?>','lhc_screenshot')" /><input type="button" value="Actualizar" class="btn btn-default" onclick="lhinst.updateScreenshot('<?php  echo $chat->id?>')" /></div><div id="user-screenshot-container"><?php  if ($chat->screenshot !== false) : ?><h5>Tomada <?php  echo $chat->screenshot->date_front?></h5><a href="/chat/lhc_web/index.php/site_admin/file/downloadfile/<?php  echo $chat->screenshot->id?>/<?php  echo $chat->screenshot->security_hash?>/(inline)/true" target="_blank" class="screnshot-container"><img id="screenshotImage" src="/chat/lhc_web/index.php/site_admin/file/downloadfile/<?php  echo $chat->screenshot->id?>/<?php  echo $chat->screenshot->security_hash?>" alt="" /></a><script>$(document).ready(function(){$('.screnshot-container').zoom();});</script><?php  else : ?><br/>Vacío...<?php  endif;?></div></div><?php  endif;?><?php  $chat_chat_tabs_footprint_tab_enabled = true; ?><?php  if ($chat_chat_tabs_footprint_tab_enabled == true && '0' == 1) : ?><div role="tabpanel" class="tab-pane<?php  if ($chatTabsOrderDefault == 'footprint_tab_tab') print ' active';?>" id="footprint-tab-chat-<?php  echo $chat->id?>"><div class="mx170"><a class="btn btn-default btn-xs" rel="<?php  echo $chat->id?>" onclick="lhinst.refreshFootPrint($(this))">Actualizar</a><ul class="foot-print-content circle" id="footprint-<?php  echo $chat->id?>"><?php $filter = $chat->online_user_id == 0 ? array('chat_id' => $chat->id) : array('online_user_id' => $chat->online_user_id); foreach (erLhcoreClassModelChatOnlineUserFootprint::getList(array('filter' => $filter)) as $footprintItems) : ?><li><a target="_blank" href="<?php  echo htmlspecialchars($footprintItems->page);?>"><?php  echo $footprintItems->time_ago?> | <?php  echo htmlspecialchars($footprintItems->page);?></a></li><?php  endforeach;?></ul></div></div><?php  endif;?><?php  $information_tab_map_tab_enabled = true;?><?php  if ($information_tab_map_tab_enabled == true) : ?><div role="tabpanel" class="tab-pane<?php  if ($chatTabsOrderDefault == 'map_tab_tab') print ' active';?>" id="map-tab-chat-<?php  echo $chat->id?>"><?php  if ($chat->lat != 0 && $chat->lon) : ?><a target="_blank" href="//maps.google.com/maps?t=h&q=<?php  echo $chat->lat?>,<?php  echo $chat->lon?>&z=17&hl=en&z=11&t=m"><img src="//maps.google.com/maps/api/staticmap?zoom=13&size=400x300&maptype=roadmap&center=<?php  echo $chat->lat?>,<?php  echo $chat->lon?>&sensor=false&markers=color:green|<?php  echo $chat->lat?>,<?php  echo $chat->lon?>" alt="" title="<?php  echo $chat->lat?>,<?php  echo $chat->lon?>" /></a>
<?php  else : ?><p>No se ha detectado. Asegúrese de que la detección GEO está habilitada.</p><?php  endif;?></div><?php  endif;?><?php  if (($online_user = $chat->online_user) !== false) : ?><?php  $information_tab_online_user_info_enabled = true;?><?php  if ($information_tab_online_user_info_enabled == true) : ?><div role="tabpanel" class="tab-pane<?php  if ($chatTabsOrderDefault == 'online_user_info_tab') print ' active';?>" id="online-user-info-tab-<?php  echo $chat->id?>"><a class="btn btn-default btn-xs" rel="<?php  echo $chat->id?>" onclick="lhinst.refreshOnlineUserInfo($(this))">Actualizar</a><div id="online-user-info-<?php  echo $chat->id?>"><div class="pull-right"><p class="fs12"><?php  if ( !empty($online_user->user_country_code) ) : ?><img src="/chat/lhc_web/design/defaulttheme/images/flags/<?php  echo $online_user->user_country_code?>.png" alt="<?php  echo htmlspecialchars($online_user->user_country_name)?>" title="<?php  echo htmlspecialchars($online_user->user_country_name)?>" /><?php  endif; ?> (<?php  echo $online_user->ip?>)<?php  if ( !empty($online_user->city) ) :?><br/>Ciudad: <?php  echo htmlspecialchars($online_user->city) ?><?php  endif;?><?php  if ( !empty($online_user->lat) ) :?><br/>Lat. <?php  echo htmlspecialchars($online_user->lat) ?><?php  endif;?><?php  if ( !empty($online_user->lon) ) :?><br/>Lon. <?php  echo htmlspecialchars($online_user->lon) ?><?php  endif;?><?php  if ( !empty($online_user->visitor_tz) ) :?><br/>Zona horaria: <?php  echo htmlspecialchars($online_user->visitor_tz),' ',$online_user->visitor_tz_time ?><?php  endif;?><?php  if (!empty($online_user->identifier)) : ?><br/>Identificador - <?php  echo htmlspecialchars($online_user->identifier)?><?php  endif;?></p><?php  if ($online_user->online_attr != '') : ?><h5>Información adicional</h5><pre><?php  echo htmlspecialchars(json_encode(json_decode($online_user->online_attr),JSON_PRETTY_PRINT));?></pre><?php  endif;?></div><h5>Última actividad <?php  echo htmlspecialchars($online_user->lastactivity_ago)?> hace<?php  $timeoutOnPage = (int)'0'; if ($timeoutOnPage > 0) : ?>,<br/><b>En la página - <?php  if ($online_user->last_check_time_ago < ($timeoutOnPage+3)) : ?><i class="icon-user-status material-icons icon-user-online" title="Si">face</i><?php  else : ?><i class="icon-user-status material-icons" title="No">face</i><?php  endif;?></b><?php  endif;?></h5><ul class="list-unstyled"><li><i class="material-icons">face</i><?php  if ($online_user->message_seen == 0) : ?><?php  if ($online_user->operator_message == '') : ?>El usuario no tiene ningún mensaje del operador<?php  else : ?>El usuario no ha visto un mensaje del operador o la ventana del mensaje sigue abierta.<?php  endif; ?><?php  else : ?>El usuario ha visto el mensaje del operador.<?php  endif; ?></li><li><?php  if ($online_user->chat_id > 0) : ?><?php  if ($online_user->can_view_chat == true) : ?><a href="#" onclick="return lhc.previewChat('<?php  echo $online_user->chat_id?>');"><?php  endif;?><i class="material-icons chat-active">chat</i>El usuario tiene un chat activo<?php  if ($online_user->can_view_chat == true) : ?></a><?php  endif;?><?php  else : ?><i class="material-icons">chat</i>El usuario no tiene ningun chat abierto actualmente<?php  endif; ?></li><li><i title="Operador" class="material-icons">account_box</i><?php  if ( ($operator_user = $online_user->operator_user) !== false ) : ?><?php  echo htmlspecialchars($operator_user); ?> ha enviado un mensaje al usuario<?php  else : ?>Todavia no se han enviado mensajes al usuario<?php  endif; ?></li><li>Primera visita - <?php  echo $online_user->first_visit_front?></li><li>Última visita - <?php  echo $online_user->last_visit_front?></li><li>Total de visitas - <?php  echo $online_user->total_visits?></li><li><?php  echo $online_user->invitation_count?> veces(s) que la logica en invitación fue aplicada</li><li>Páginas Vistas - <?php  echo $online_user->pages_count?></li><li>Total de páginas vistas - <?php  echo $online_user->tt_pages_count?></li><li>Tiempo en el sitio - <?php  echo $online_user->time_on_site_front?></li><li>Tiempo total en el sitio - <?php  echo $online_user->tt_time_on_site_front?></li><li>Página actual - <a target="_blank" href="<?php  echo htmlspecialchars($online_user->current_page)?>" title="<?php  echo htmlspecialchars($online_user->current_page)?>"><?php  echo erLhcoreClassDesign::shrt($online_user->current_page,100,100);?></a></li><li>Vino de - <a target="_blank" href="<?php  echo htmlspecialchars($online_user->referrer)?>"><?php  echo htmlspecialchars($online_user->referrer)?></a></li><li class="fs11"><i class="material-icons">language</i><?php  echo htmlspecialchars($online_user->user_agent)?></li></ul></div></div><?php  endif;?><?php  $information_tab_online_user_info_chats_enabled = true?><?php  if ($information_tab_online_user_info_chats_enabled == true) : ?><div role="tabpanel" class="tab-pane" id="online-user-info-chats-tab-<?php  echo $chat->id?>"><ul class="foot-print-content list-unstyled" style="max-height: 170px;"><?php  $hasPrevChat = false; foreach (erLhcoreClassChat::getList(array('limit' => 100, 'filter' => array('online_user_id' => $online_user->id))) as $chatPrev) : ?><?php  if (!isset($chat) || $chat->id != $chatPrev->id) : $hasPrevChat = true;?><li><?php  if ( !empty($chatPrev->country_code) ) : ?><img src="/chat/lhc_web/design/defaulttheme/images/flags/<?php  echo $chatPrev->country_code?>.png" alt="<?php  echo htmlspecialchars($chatPrev->country_name)?>" title="<?php  echo htmlspecialchars($chatPrev->country_name)?>" />&nbsp;<?php  endif; ?><a title="Abrir en una ventana nueva" class="material-icons" onclick="lhinst.startChatNewWindow('<?php  echo $chatPrev->id;?>',$(this).attr('data-title'))" data-title="<?php  echo htmlspecialchars($chatPrev->nick,ENT_QUOTES);?>">open_in_new</a><?php  echo $chatPrev->id;?>. <?php  echo htmlspecialchars($chatPrev->nick);?> (<?php  echo date(erLhcoreClassModule::$dateDateHourFormat,$chatPrev->time);?>) (<?php  echo htmlspecialchars($chatPrev->department);?>)</li><?php  endif; ?><?php  endforeach;?></ul><?php  if ($hasPrevChat == false) : ?>No previous chats<?php  endif;?></div><?php  endif; ?><?php  endif; ?><?php   ?></div></div><?php   ?></div></div><script type="text/javascript">lhinst.addSynchroChat('<?php  echo $chat->id;?>','<?php  echo $LastMessageID?>');$('#messagesBlock-<?php  echo $chat->id?>').animate({ scrollTop: $('#messagesBlock-<?php  echo $chat->id?>').prop('scrollHeight') }, 1000);// Start synchronisation
lhinst.startSyncAdmin();</script>